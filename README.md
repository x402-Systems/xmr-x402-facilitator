# Universal Monero x402 Facilitator (Daemon)

An open-source, privacy-respecting payment oracle that implements the **HTTP 402 (Payment Required)** protocol for Monero (XMR). 

This project acts as a **sidecar daemon** for web servers, AI agents, and microservices. It bridges the gap between the "Agentic Web" (x402) and Monero's private-by-default network, allowing any application (Go, JS, Python, Rust) to accept XMR without needing to implement complex blockchain logic.

## Vision
To provide a sovereign, self-hosted alternative to corporate payment facilitators. By running this daemon alongside your application, you can gate resources behind XMR micro-payments while maintaining 100% control over your own View Keys and Node infrastructure.

## Protocol Flow
![Flow Chart](assets/flow-chart.png)

## âœ¨ Features
- **Universal Sidecar:** RESTful API for creating invoices and verifying payments from any programming language.
- **Cryptographic Proof-of-Payment:** Uses Monero's `tx_key` (Transaction Secret Key) to verify sender ownership, preventing header spoofing and replay attacks.
- **Persistent Storage:** SQLite/SQLx backend tracks invoice lifecycles (Pending, Paid, Expired).
- **Dynamic Market Pricing:** Fetches real-time XMR/USD exchange rates via CoinGecko.
- **0-Conf Ready:** Scans the mempool for incoming transactions to provide an instant "Web Native" experience.
- **Privacy Centric:** Generates unique subaddresses for every request; no address reuse.

## ðŸ›  Tech Stack
- **Language:** Rust (Axum)
- **Database:** SQLite (SQLx)
- **Crypto Integration:** Monero-Wallet-RPC
- **Pricing:** CoinGecko API

## Getting Started

### Prerequisites
1. **Monero Wallet RPC:** Must be running with a wallet file loaded.
   ```bash
   monero-wallet-rpc --stagenet --rpc-bind-port 18083 --disable-rpc-login --wallet-file your_wallet
   ```
2. **Rust Toolchain:** (Cargo/Rustc)

### Installation
1. **Configure:**
   ```bash
   cp .env.example .env
   # Edit .env with your RPC URL and Database path
   ```
2. **Initialize Database:**
   ```bash
   touch facilitator.db
   sqlite3 facilitator.db "CREATE TABLE invoices (address TEXT PRIMARY KEY, amount_required INTEGER NOT NULL, metadata TEXT, status TEXT, tx_id TEXT, created_at INTEGER NOT NULL);"
   ```
3. **Build & Run:**
   ```bash
   cargo run
   ```

## Universal API Reference

### 1. Create Invoice (`POST /invoices`)
Called by the Merchant App to generate a payment challenge.
- **Input:** `{"amount_usd": 0.50, "metadata": "vps_id_101"}`
- **Returns:** `{"address": "7...", "amount_piconero": 12345, "invoice_id": "...", "status": "pending", "network": "stagenet"}`

### 2. Verify Payment (`POST /verify`)
Called to submit cryptographic proof of payment.
- **Input:** `{"address": "7...", "tx_id": "...", "tx_key": "..."}`
- **Returns:** `{"status": "paid", "amount_received": 12345}`

### 3. Check Status (`GET /invoices/:address`)
Polls the current status of an invoice.

## Security: The `tx_key` Advantage
Unlike transparent ledgers where seeing a transaction is enough proof, Monero's privacy requires the sender to prove they are the one who sent the funds. This facilitator requires the client to provide the `tx_key` generated by their wallet. 
- The facilitator uses `check_tx_key` via RPC to verify that the key proves a transfer to the specific subaddress.
- This ensures that users cannot "spoof" headers by simply finding high-value TXIDs on a block explorer.

## Status: Proof of Concept
- [x] Universal REST API
- [x] Cryptographic verification (tx_key)
- [x] SQLite persistence
- [ ] Webhook support (Next)
- [ ] Tor / .onion service support (Next)

## Contributing
This is an open-source project designed to strengthen the Monero ecosystem. Contributions, bug reports, and integration examples are welcome.
